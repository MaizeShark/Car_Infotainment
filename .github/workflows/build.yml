name: Linux Qt CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

# Cancel older builds on the same branch to save resources
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    # Define compiler variables explicitly for CMake
    env:
      CC: gcc
      CXX: g++

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- 1. System Dependencies ---
      - name: Install System Dependencies
        # libxcb-cursor0 is critical for Qt6 on Ubuntu 22.04+
        # libwayland/vulkan are needed for your specific imports
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libgl1-mesa-dev libvulkan-dev libwayland-dev libxkbcommon-dev libxcb-cursor0

      # --- 2. Setup Ninja ---
      - name: Setup Ninja
        uses: ashutoshvarma/setup-ninja@master
        with:
          version: 1.11.1 # Using 1.11+ is recommended for speed

      # --- 3. Compiler Caching (Speed Boost) ---
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: linux-qt6-gcc

      # --- 4. Install Qt ---
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.8.3'
          cache: true
          aqtversion: '==3.1.*'
          # Included WaylandCompositor as this is a Linux build
          modules: 'qtwaylandcompositor qtquick3d qtshadertools qt5compat'

      # --- 5. Configure CMake ---
      - name: Configure CMake
        # We manually run cmake here to inject CCACHE and INSTALL_PREFIX
        run: >
          cmake -S . -B build
          -G Ninja
          -DCMAKE_BUILD_TYPE=Release
          -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/staged
          -DCMAKE_C_COMPILER_LAUNCHER=ccache
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      # --- 6. Build ---
      - name: Build
        run: cmake --build build --parallel

      # --- 7. Test ---
      - name: Run Tests
        run: ctest --test-dir build --output-on-failure

      # --- 8. Install/Stage ---
      - name: Install to Staging
        # This executes the 'install(TARGETS...)' command from your CMakeLists.txt
        # It copies the binary and assets to the 'staged' folder defined in Configure step
        run: cmake --install build

      # --- 9. Upload ---
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: CarInfotainment-Linux
          path: staged/
